{
    "componentChunkName": "component---src-pages-blog-mdx-slug-js",
    "path": "/blog/rails-on-docker-part-two/",
    "result": {"data":{"mdx":{"frontmatter":{"title":"Rails on Docker Part Two","tags":["Rails","Docker","digitalocean"],"categories":["programming"],"date":"April 02, 2022","image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#080808","images":{"fallback":{"src":"/static/2543884e9681765acc3fd0ffffe2b917/1223f/horizontal-logo-monochromatic-white.png","srcSet":"/static/2543884e9681765acc3fd0ffffe2b917/6f368/horizontal-logo-monochromatic-white.png 301w,\n/static/2543884e9681765acc3fd0ffffe2b917/660f0/horizontal-logo-monochromatic-white.png 601w,\n/static/2543884e9681765acc3fd0ffffe2b917/1223f/horizontal-logo-monochromatic-white.png 1202w","sizes":"(min-width: 1202px) 1202px, 100vw"},"sources":[{"srcSet":"/static/2543884e9681765acc3fd0ffffe2b917/901aa/horizontal-logo-monochromatic-white.webp 301w,\n/static/2543884e9681765acc3fd0ffffe2b917/0c2e3/horizontal-logo-monochromatic-white.webp 601w,\n/static/2543884e9681765acc3fd0ffffe2b917/19e09/horizontal-logo-monochromatic-white.webp 1202w","type":"image/webp","sizes":"(min-width: 1202px) 1202px, 100vw"}]},"width":1202,"height":309}}},"imageAlt":"Docker"},"id":"534e725d-71be-5e6f-ace7-75db51185701","body":"var _excluded = [\"components\"];\nfunction _extends() { _extends = Object.assign ? Object.assign.bind() : function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n/* @jsxRuntime classic */\n/* @jsx mdx */\n\nvar _frontmatter = {\n  \"title\": \"Rails on Docker Part Two\",\n  \"date\": \"2022-04-02T00:00:00.000Z\",\n  \"tags\": [\"Rails\", \"Docker\", \"digitalocean\"],\n  \"categories\": [\"programming\"],\n  \"draft\": false,\n  \"image\": \"./horizontal-logo-monochromatic-white.png\",\n  \"imageAlt\": \"Docker\"\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n    props = _objectWithoutProperties(_ref, _excluded);\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"As I continued following along the tutorial from the book \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://pragprog.com/titles/ridocker/docker-for-rails-developers/\"\n  }, \"Docker for Rails Developers\"), \",\\nit was about to become evident that a lot had changed since it was written. By now, my little sample application had grown. I added a database\\nand scaffolded a User model and controller, just to confirm I was able to create, edit and delete records. I also added React and wired up a very simple\\ncomponent. Lastly, I setup a page that used Redis to increment a counter, just to confirm that the application was able to connect to the Redis service.\"), mdx(\"p\", null, \"By then, my Dockerfile was looking like this:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"FROM ruby:2.7\\n\\n# Allow apt to work with http-based resources\\nRUN apt-get update -yqq && apt-get install -yqq --no-install-recommends \\\\\\napt-transport-https\\n\\nRUN curl https://deb.nodesource.com/setup_12.x | bash\\nRUN curl https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -\\nRUN echo \\\"deb https://dl.yarnpkg.com/debian/ stable main\\\" | tee /etc/apt/sources.list.d/yarn.list\\n\\nRUN apt-get update -yqq && apt-get install -yqq --no-install-recommends \\\\\\nnodejs \\\\\\nyarn \\\\\\n&& rm -rf /var/lib/apt/lists/*\\n\\nWORKDIR /usr/src/app\\nCOPY Gemfile* /usr/src/app/\\n\\nENV BUNDLE_PATH /gems\\nRUN bundle install\\n\\nCOPY . /usr/src/app/\\n\\nENTRYPOINT [\\\"./docker-entrypoint.sh\\\"]\\n\\nCMD [\\\"bin/rails\\\", \\\"s\\\", \\\"-b\\\", \\\"0.0.0.0\\\"]\\n\")), mdx(\"p\", null, \"The docker-entrypoint.sh file includes commands that will be run prior to launching the application,\\nand it had the following contents.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"#!/bin/sh\\n\\nset -e\\n\\nif [-f tmp/pids/server.pid]; then\\n  rm tmp/pids/server.pid\\nfi\\n\\n\\nexec \\\"$@\\\"\\n\")), mdx(\"p\", null, \"My docker-compose.yml file had also grown to include a service for a postgres database and a volume to cache the gems.\\nI had extracted the environment variables into a couple of .env files.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"version: '3'\\n\\nservices:\\n  web:\\n    build: .\\n    ports:\\n      - \\\"3000:3000\\\"\\n    env_file:\\n      - .env/development/database\\n      - .env/development/web\\n    environment:\\n      - WEBPACKER_DEV_SERVER_HOST=webpack\\n    depends_on:\\n      - webpack\\n    volumes:\\n      - .:/usr/src/app:cached\\n      - gem_cache:/gems\\n  \\n  webpack:\\n    build: .\\n    command: ./bin/webpack-dev-server\\n    volumes:\\n      - .:/usr/src/app\\n      - gem_cache:/gems\\n    ports:\\n      - '3035:3035'\\n    env_file:\\n      - .env/development/database\\n      - .env/development/web\\n    environment:\\n      - WEBPACKER_DEV_SERVER_HOST=0.0.0.0\\n\\n  redis:\\n    image: redis\\n\\n  database:\\n    image: postgres\\n    env_file:\\n      - .env/development/database\\n    volumes:\\n      - db_data:/var/lib/postgresql/data\\n\\nvolumes:\\n  db_data:\\n  gem_cache:\\n\")), mdx(\"p\", null, \"This all worked great in development, and now the second part of the tutorial went on to instruct how to prepare the application for production. This was supposed to be the fun part, except I wasn't\\nquite able to follow along.\"), mdx(\"p\", null, \"After creating a dedicated Dockerfile for production, which I named Dockerfile.prod, plus a docker-stack.yml file, which looked like a simplified\\nversion of the docker-compose.yml file, the tutorial goes on to use VirtualBox to create a virtual machine that mimics a\\nproduction environment locally. I, however, am using a computer with an Apple M1 pro chip and was not able to find a\\ncompatible version of VirtualBox or similar, so I had to skip this part. \"), mdx(\"p\", null, \"Next, the tutorial proceeds to build a new image using the production Dockerfile and push it to Docker hub. This image will then be\\nused to deploy to DigitalOcean using the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"docker-machine\"), \" command. This command, however, appears to have been deprecated some time\\nago, so I wasn't able to follow along this part either. I did, however, create an account with DigitalOcean, so I was determined to find a\\nway to deploy my image.\"), mdx(\"p\", null, \"Rather than creating a droplet and figure out a way to put my image in it, I discovered DigitalOcean has a handy Apps section that can very much\\nhelp you with the process of deploying your application. There's different ways to choose the source of your application. You can create an image registry and push your custom image to it,\\nyou can use an existing image from Docker hub, or you can use a repository in Github.\"), mdx(\"p\", null, \"As a first attempt, I tried using the production image I had pushed to Docker hub previously, but there were\\na few errors in my image that I couldn't figure out, and the build kept failing. My next attempt was to use the Github repo of my sample application as the source. DigitalOcean detected\\nthere was a Dockerfile in there, and used it to build an image and deploy a dockerised Rails application. For this to work, however, I had to rename the production Dockerfile.prod I had created previously to simply Dockerfile,\\nso DigitalOcean would use that one, instead of the one I had for development. There were subtle differences between those two Dockerfile files; mainly the\\naddition of an instruction to precompile assets, just before the ENTRYPOINT.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"RUN bin/rails assets:precompile\\n\")), mdx(\"p\", null, \"As part of the deployment process, I had DigitalOcean provide a postgres database that my application could use. Notice that, by default, the database that is provided is a development database,\\nwhich is not really ready for production. You can, of course, upgrade to a production ready database for an extra fee. Since my Rails application was dependent on Redis, I also needed to create a Redis cluster in DigitalOcean.\\nDoing this, of course, same as upgrading to a production ready postgres database, increases the cost of hosting and running your application with them. Nothing is free!\"), mdx(\"p\", null, \"I should mention I had previously modified the docker-entrypoint.sh file to include an instruction to migrate the database. This worked for me this one time, but according to Isenberg, it's not\\nreally a good idea, since it doesn't scale well. He explains how to create a migrator service to take care of this, instead, although since my deployment process ended up substantially different from\\nhis, I wasn't really sure how to adapt to my particular case.\"), mdx(\"p\", null, \"Below is a screenshot of all environment variables for my deployed application, which you will also need to provide. Notice that the value of REDIS_URL corresponds to the connection string to the\\nRedis cluster that was created by DigitalOcean. The SECRET_KEY_BASE I generated in advance by running the command \"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"docker-compose\\u200B\\u200B \\u200B\\u200Bexec\\u200B\\u200B \\u200B\\u200Bweb\\u200B\\u200B \\u200B\\u200Bbin/rails\\u200B\\u200B \\u200B\\u200Bsecret\\n\")), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"600px\"\n    }\n  }, \"\\n      \", mdx(\"a\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-link\",\n    \"href\": \"/static/922462aada2215202c01e30fd543658e/ce0a7/envvariables.png\",\n    \"style\": {\n      \"display\": \"block\"\n    },\n    \"target\": \"_blank\",\n    \"rel\": \"noopener\"\n  }, \"\\n    \", mdx(\"span\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"87.99999999999999%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAABYlAAAWJQFJUiTwAAACEklEQVQ4y5VTaXOEIBTr//+fvXaVS+RQ8HUSjm27/VJnGBUeIXkJL5sPYqwX63ZRZpOcD8FzXdd8/2e8aLMRzO9R8B1TBozU65J8nFJrJXCtbcN4//UQ0G27KO3IsoGJlFq5aJ2X+2Ikxsz/Uhp4jFGUNvzHHqg8z9IAMQEw4zxZHufJRQysOR8IWEqbw2F7CGKtowrUp3wQnIB7SLKoxvD1feFpTRo2JjG9t1i/LUY2HxtDpSl/HDoZhpjmBhhyDialEFAbP00j01olhCjG2tbnfLAO9Z1hlGW1BD2Ok9QBive+R87rfiCkYRMBjSU45tCqyRASPm5a7qsVGASpEzBEud2NQAXNKoUyQwiitCbgkymgO2JDuX1gM4BgFno0zHpIdgRHtFA3TQGQ0hubTXbd4bP3EIeBAdZGJgGI2AAw9R5+MyW3HjnPfnFjTz0OQzs+71rePxXfbx8rnQcYev7UQwC6LZAFnUy5u1xZiGBDwUgCvkEALFGDVmDPlAygcf2wCWPcCgBCzrinPyQjh9f1bEq7w36CQbq2ngUAwzqMwAHN5TpjM3o4DH2Ywqx5xgb/oyAA0EeGF0xSD/7D5focbP8th7kHt3ZGAMZ1w4ApqENMUkqyrGpeve331RtmNKDS5VUZa7gxdtv5j4NhzsglnMaVnJJbbDyLa2fXxsU5RAXrq3IEB1MAjsyCMQ4ckr8AquZ7NAAbMfgAAAAASUVORK5CYII=')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"a\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"My environment variables\",\n    \"title\": \"My environment variables\",\n    \"src\": \"/static/922462aada2215202c01e30fd543658e/0a47e/envvariables.png\",\n    \"srcSet\": [\"/static/922462aada2215202c01e30fd543658e/8a4e8/envvariables.png 150w\", \"/static/922462aada2215202c01e30fd543658e/5a46d/envvariables.png 300w\", \"/static/922462aada2215202c01e30fd543658e/0a47e/envvariables.png 600w\", \"/static/922462aada2215202c01e30fd543658e/1cfc2/envvariables.png 900w\", \"/static/922462aada2215202c01e30fd543658e/c1b63/envvariables.png 1200w\", \"/static/922462aada2215202c01e30fd543658e/ce0a7/envvariables.png 1590w\"],\n    \"sizes\": \"(max-width: 600px) 100vw, 600px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n  \"), \"\\n    \")), mdx(\"p\", null, \"Once I figured the process, deploying new changes to my application became easier and faster, since everything that didn't change was already cached.\\nOverall, I like the simplicity offered by DigitalOcean, as well as the tools it provides to monitor the state of the different services involved. I do find\\nit a little pricey for a side project, though, which is why I eventually destroyed the application and the database cluster after I was done experimenting with them,\\nto avoid incurring in extra costs.\"));\n}\n;\nMDXContent.isMDXComponent = true;","timeToRead":3,"slug":"rails-on-docker-part-two/"},"allMdx":{"edges":[{"next":{"slug":"2013-03-17-silicon-valley-devfest/","frontmatter":{"title":"Silicon Valley DevFest"},"id":"edcdad98-0f1c-5f08-b9bf-ef2584a6784d"},"previous":null,"node":{"id":"3378703f-653c-58fd-a11e-7adc675fb79e","frontmatter":{"title":"Makings of a Pythonista"},"slug":"2012-11-21-makings-of-a-pythonista"}},{"next":{"slug":"2015-06-14-in-search-of-a-faster-query","frontmatter":{"title":"In search of a faster query"},"id":"c6497654-5ee0-5b14-b735-e08bbbc6a4bf"},"previous":{"frontmatter":{"title":"Makings of a Pythonista"},"slug":"2012-11-21-makings-of-a-pythonista"},"node":{"id":"edcdad98-0f1c-5f08-b9bf-ef2584a6784d","frontmatter":{"title":"Silicon Valley DevFest"},"slug":"2013-03-17-silicon-valley-devfest/"}},{"next":{"slug":"2015-11-01-diary-of-a-dev-joys-of-building","frontmatter":{"title":"Diary of a Junior Dev: The joys of building"},"id":"ca6c84a6-3aea-5278-bf26-267d43acb227"},"previous":{"frontmatter":{"title":"Silicon Valley DevFest"},"slug":"2013-03-17-silicon-valley-devfest/"},"node":{"id":"c6497654-5ee0-5b14-b735-e08bbbc6a4bf","frontmatter":{"title":"In search of a faster query"},"slug":"2015-06-14-in-search-of-a-faster-query"}},{"next":{"slug":"2016-12-24-working-with-d3-based-chart-library/","frontmatter":{"title":"TIL: Working with a D3 based chart library"},"id":"776dcc9f-2ac4-511a-a9c6-982c226e0478"},"previous":{"frontmatter":{"title":"In search of a faster query"},"slug":"2015-06-14-in-search-of-a-faster-query"},"node":{"id":"ca6c84a6-3aea-5278-bf26-267d43acb227","frontmatter":{"title":"Diary of a Junior Dev: The joys of building"},"slug":"2015-11-01-diary-of-a-dev-joys-of-building"}},{"next":{"slug":"2017-03-15-react-conf-2017/","frontmatter":{"title":"React Conf 2017"},"id":"97c0196c-f0cd-5d6a-b2b9-fd3c6f1f1baa"},"previous":{"frontmatter":{"title":"Diary of a Junior Dev: The joys of building"},"slug":"2015-11-01-diary-of-a-dev-joys-of-building"},"node":{"id":"776dcc9f-2ac4-511a-a9c6-982c226e0478","frontmatter":{"title":"TIL: Working with a D3 based chart library"},"slug":"2016-12-24-working-with-d3-based-chart-library/"}},{"next":{"slug":"2017-04-12-the-initial-state-gotcha","frontmatter":{"title":"The Initial State Gotcha"},"id":"82041731-cb81-571d-958c-00f57d99b927"},"previous":{"frontmatter":{"title":"TIL: Working with a D3 based chart library"},"slug":"2016-12-24-working-with-d3-based-chart-library/"},"node":{"id":"97c0196c-f0cd-5d6a-b2b9-fd3c6f1f1baa","frontmatter":{"title":"React Conf 2017"},"slug":"2017-03-15-react-conf-2017/"}},{"next":{"slug":"2017-05-13-blue-socks-at-orange/","frontmatter":{"title":"Blue Socks Spotted at Orange"},"id":"893cf729-88c0-5706-bcb8-d14f75a30f2b"},"previous":{"frontmatter":{"title":"React Conf 2017"},"slug":"2017-03-15-react-conf-2017/"},"node":{"id":"82041731-cb81-571d-958c-00f57d99b927","frontmatter":{"title":"The Initial State Gotcha"},"slug":"2017-04-12-the-initial-state-gotcha"}},{"next":{"slug":"learning-gatsby/","frontmatter":{"title":"Learning about Gatsby"},"id":"9a370e4e-c279-5fe6-bd67-96e83d07e388"},"previous":{"frontmatter":{"title":"The Initial State Gotcha"},"slug":"2017-04-12-the-initial-state-gotcha"},"node":{"id":"893cf729-88c0-5706-bcb8-d14f75a30f2b","frontmatter":{"title":"Blue Socks Spotted at Orange"},"slug":"2017-05-13-blue-socks-at-orange/"}},{"next":{"slug":"once-upon-a-blog/","frontmatter":{"title":"Once upon a Blog"},"id":"db5caf55-934b-5de1-aa6b-5a2078e4f869"},"previous":{"frontmatter":{"title":"Blue Socks Spotted at Orange"},"slug":"2017-05-13-blue-socks-at-orange/"},"node":{"id":"9a370e4e-c279-5fe6-bd67-96e83d07e388","frontmatter":{"title":"Learning about Gatsby"},"slug":"learning-gatsby/"}},{"next":{"slug":"story-of-a-laptop-upgrade","frontmatter":{"title":"Story of a laptop upgrade"},"id":"91dabe95-0227-5d01-b1d1-f10959c5d43a"},"previous":{"frontmatter":{"title":"Learning about Gatsby"},"slug":"learning-gatsby/"},"node":{"id":"db5caf55-934b-5de1-aa6b-5a2078e4f869","frontmatter":{"title":"Once upon a Blog"},"slug":"once-upon-a-blog/"}},{"next":{"slug":"the-code-we-write-today/","frontmatter":{"title":"The code we write today"},"id":"08584458-be98-53c2-8cf3-9fa51060e04b"},"previous":{"frontmatter":{"title":"Once upon a Blog"},"slug":"once-upon-a-blog/"},"node":{"id":"91dabe95-0227-5d01-b1d1-f10959c5d43a","frontmatter":{"title":"Story of a laptop upgrade"},"slug":"story-of-a-laptop-upgrade"}},{"next":{"slug":"rails-on-docker/","frontmatter":{"title":"Rails on Docker"},"id":"5e92911a-24f7-562d-8ecd-9a7391960489"},"previous":{"frontmatter":{"title":"Story of a laptop upgrade"},"slug":"story-of-a-laptop-upgrade"},"node":{"id":"08584458-be98-53c2-8cf3-9fa51060e04b","frontmatter":{"title":"The code we write today"},"slug":"the-code-we-write-today/"}},{"next":{"slug":"rails-on-docker-part-two/","frontmatter":{"title":"Rails on Docker Part Two"},"id":"534e725d-71be-5e6f-ace7-75db51185701"},"previous":{"frontmatter":{"title":"The code we write today"},"slug":"the-code-we-write-today/"},"node":{"id":"5e92911a-24f7-562d-8ecd-9a7391960489","frontmatter":{"title":"Rails on Docker"},"slug":"rails-on-docker/"}},{"next":{"slug":"super-powers-for-active-record-relation","frontmatter":{"title":"Super Powers for ActiveRecord::Relation"},"id":"3d5d8b08-cf43-57be-8c43-aad95e2dfd06"},"previous":{"frontmatter":{"title":"Rails on Docker"},"slug":"rails-on-docker/"},"node":{"id":"534e725d-71be-5e6f-ace7-75db51185701","frontmatter":{"title":"Rails on Docker Part Two"},"slug":"rails-on-docker-part-two/"}},{"next":null,"previous":{"frontmatter":{"title":"Rails on Docker Part Two"},"slug":"rails-on-docker-part-two/"},"node":{"id":"3d5d8b08-cf43-57be-8c43-aad95e2dfd06","frontmatter":{"title":"Super Powers for ActiveRecord::Relation"},"slug":"super-powers-for-active-record-relation"}}]}},"pageContext":{"id":"534e725d-71be-5e6f-ace7-75db51185701","slug":"rails-on-docker-part-two/","__params":{"slug":"rails-on-docker-part-two"}}},
    "staticQueryHashes": ["2201243204","2744905544"]}